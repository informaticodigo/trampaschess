import requests, chess
from time import sleep
from stockfish import Stockfish


def getbookmoves(fen, moves, profundidad):
    global porcentaje
    if profundidad <= 0:
        print("fin linea")
    else:
        params = (
            ('variant', 'standard'),
            ('recentGames', 0),
            ('topGames', 0),
            ('moves', moves),
            ('speeds[]', ['blitz', 'rapid', 'classical']),
            ('ratings[]', ['2200', '2500']),
            ('fen', fen),
        )
        response = requests.get('https://explorer.lichess.ovh/lichess', params=params)
        parsed = response.json()
        for i in range(0, moves):
            try:
                if parsed["moves"][i]["white"] + parsed["moves"][i]["black"] + parsed["moves"][i]["draws"] / parsed["moves"][0]["white"] + parsed["moves"][0]["black"] + parsed["moves"][0]["draws"] >= porcentaje:
                    stockfish.set_fen_position(fen)
                    val_ant = stockfish.get_evaluation()['value']/100
                    stockfish.make_moves_from_current_position([parsed["moves"][i]["uci"]])
                    val_act = stockfish.get_evaluation()['value']/100
                    is_incorrect = abs(val_act - val_ant) >= 1
                    if is_incorrect:
                        board = chess.Board(fen)
                        board.push_san(parsed["moves"][i]["san"])
                        stockfish.set_fen_position(board.fen())
                        a = stockfish.get_best_move_time(5000)
                        print({
                            'cmove': a,
                            'var': "{} - {}".format(val_ant, val_act),
                            'fen': fen,
                            'san': parsed["moves"][i]["san"]
                        })
                        profundidad -= 1
                        getbookmoves(board.fen(), moves, profundidad)
                    else:
                        print(parsed["moves"][i]["san"], " - ", val_act, " - ", val_ant)
            except:
                pass
            sleep(0.1)


stockfish = Stockfish("stockfish.exe")
stockfish.set_skill_level(20)
stockfish.set_depth(13)
stockfish.set_elo_rating(3500)

fen = "rnbqkbnr/pp2pppp/3p4/2p5/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 0 1"
moves = 50
profundidad = 50
porcentaje = 0.1

getbookmoves(fen, moves, profundidad)
